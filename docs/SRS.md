# 照片水印添加程序软件需求规格说明书 (SRS)

**项目**: Photo Watermark Tool
**版本**: 1.0.0
**日期**: 2025-09-24
**课程**: 南京大学大模型辅助软件工程课程作业1
**开发方式**: Vibe Coding with Claude Code

---

## 1. 项目概述

### 1.1 项目名称
照片水印添加程序 (Photo Watermark Tool)

### 1.2 项目背景
南京大学大模型辅助软件工程课程作业1，实现一个命令行程序，为照片批量添加基于EXIF拍摄时间的水印。项目采用 Vibe Coding 开发方式，使用 Claude Code 协助开发实现。

### 1.3 项目目标
- 提供简单易用的命令行接口
- 支持多种图片格式的EXIF信息读取
- 实现可配置的水印样式和位置
- 确保原始图片安全，水印图片单独保存
- 支持批量处理和详细信息显示

---

## 2. 功能需求

### 2.1 核心功能需求

#### FR-001: 图片路径输入
- **需求描述**: 用户能够通过命令行输入图片文件路径或目录路径
- **优先级**: 高
- **输入**: 单个图片文件路径或包含图片的目录路径
- **支持格式**: JPG, JPEG, PNG, TIFF, TIF, BMP
- **验证**: 自动验证路径存在性和文件格式支持

#### FR-002: EXIF信息读取
- **需求描述**: 提取图片的拍摄时间信息
- **优先级**: 高
- **主要数据源**: EXIF DateTimeOriginal, DateTimeDigitized
- **备选数据源**: EXIF DateTime, 文件修改时间
- **输出格式**: YYYY-MM-DD（用于水印显示）
- **多库支持**: PIL (主要) + ExifRead (备选)
- **备选机制**: 当EXIF信息不存在时，使用文件修改时间

#### FR-003: 水印样式设置
- **需求描述**: 用户可自定义水印的显示样式
- **优先级**: 高
- **可配置参数**:
  - 字体大小：可配置像素大小（默认36px）
  - 字体颜色：支持命名颜色和十六进制颜色（默认white）
  - 水印位置：5个预设位置（top-left, top-right, bottom-left, bottom-right, center）
  - 输出质量：可配置1-100（默认95%）

#### FR-004: 水印添加与保存
- **需求描述**: 将时间水印绘制到图片上并保存
- **优先级**: 高
- **绘制特性**:
  - 自动添加对比色轮廓提高可读性
  - 支持跨平台字体自动选择
  - 使用PIL ImageDraw进行文字绘制
- **保存规则**:
  - 在原目录下创建 `原目录名_watermark` 子目录
  - 保持原文件名，保存带水印的新图片
  - 保留原图片不变

### 2.2 扩展功能需求

#### FR-005: 批量处理
- **需求描述**: 支持目录下多张图片的批量处理
- **优先级**: 中
- **处理逻辑**:
  - 自动扫描目录下的所有支持格式图片
  - 对每张图片独立执行水印添加
  - 提供成功/总数的处理统计

#### FR-006: 详细信息显示
- **需求描述**: 提供详细的处理和时间戳信息
- **优先级**: 中
- **信息内容**:
  - 原始时间戳：显示EXIF中的所有时间信息
  - 水印详情：显示字体、位置、颜色等详细配置
  - 图片信息：显示尺寸、模式等基本信息
- **控制参数**: 通过--show-watermark-info参数控制

#### FR-007: 配置文件支持
- **需求描述**: 支持YAML配置文件
- **优先级**: 低
- **功能特性**:
  - 从default_config.yaml加载默认配置
  - 支持将配置保存为YAML文件
  - 优先级：命令行参数 > 配置文件 > 默认值

#### FR-008: 错误处理与日志
- **需求描述**: 完善的错误处理和日志系统
- **优先级**: 中
- **处理方式**:
  - 支持verbose和normal日志模式
  - 单个文件失败不影响批量处理
  - 提供清晰的错误信息和建议

---

## 3. 非功能性需求

### 3.1 性能需求
- **NFR-001**: 单张图片处理时间 < 3秒
- **NFR-002**: 支持处理大尺寸图片（> 10MB）
- **NFR-003**: 内存使用合理，支持批量处理

### 3.2 可用性需求
- **NFR-004**: 命令行界面简洁直观，参数设置清晰
- **NFR-005**: 提供完整的使用说明和示例
- **NFR-006**: 错误提示清晰友好

### 3.3 可靠性需求
- **NFR-007**: 程序运行稳定，不会因个别文件问题导致整体崩溃
- **NFR-008**: 保证原始文件不被修改或损坏
- **NFR-009**: 提供备选机制（EXIF缺失时使用文件时间）

### 3.4 兼容性需求
- **NFR-010**: 支持主流操作系统（Windows、Linux、macOS）
- **NFR-011**: 兼容Python 3.8+
- **NFR-012**: 支持主流图片格式

---

## 4. 系统架构

### 4.1 模块结构
```
src/
├── main.py                    # 程序入口和参数解析
├── watermark/
│   └── watermark_processor.py # 水印处理核心逻辑
├── exif_reader/
│   └── exif_reader.py         # EXIF信息读取
└── utils/
    ├── config.py              # 配置管理
    └── logger.py              # 日志系统
```

### 4.2 数据流
1. **输入阶段**: 解析命令行参数，验证路径
2. **读取阶段**: 扫描图片文件，读取EXIF信息
3. **处理阶段**: 生成水印，绘制到图片
4. **输出阶段**: 保存到指定目录，输出统计信息

---

## 5. 接口设计

### 5.1 命令行接口
```bash
python -m src.main <path> [options]

参数:
  path                     图片文件或目录路径
  --font-size INT         字体大小 (默认: 36)
  --color STR             水印颜色 (默认: white)
  --position STR          水印位置 (默认: bottom-right)
  --output-quality INT    输出质量 1-100 (默认: 95)
  --verbose, -v           详细日志输出
  --show-watermark-info   显示详细水印信息
```

### 5.2 配置文件接口
```yaml
# config/default_config.yaml
font_size: 36
color: "white"
position: "bottom-right"
output_quality: 95
```

---

## 6. 数据需求

### 6.1 输入数据
- **图片文件**: 支持JPG, JPEG, PNG, TIFF等格式
- **EXIF数据**: DateTimeOriginal, DateTimeDigitized, DateTime标签
- **用户配置**: 字体、颜色、位置等参数

### 6.2 输出数据
- **水印图片**: 与原图同名的带水印文件
- **处理日志**: 成功/失败统计和详细信息
- **时间戳报告**: 原始拍摄时间和使用的时间源

---

## 7. 技术约束与限制

### 7.1 技术约束
- 基于Python 3.8+和PIL库实现
- 命令行程序，无GUI界面
- 依赖系统字体进行文字渲染

### 7.2 业务约束
- 水印内容仅限日期信息（YYYY-MM-DD格式）
- 输出目录结构固定为 `原目录名_watermark`
- 原始文件保持不变

---

## 8. 验收标准

### 8.1 功能验收
- ✅ 能正确读取图片EXIF中的拍摄时间信息
- ✅ 支持EXIF缺失时的文件时间备选机制
- ✅ 能根据用户设置添加水印到指定位置
- ✅ 能批量处理目录下的所有图片
- ✅ 能在指定目录结构下保存结果
- ✅ 支持详细的水印信息显示
- ✅ 支持YAML配置文件

### 8.2 质量验收
- ✅ 程序运行稳定，无崩溃
- ✅ 错误处理完善，提示信息清晰
- ✅ 处理速度满足性能要求（< 3秒/张）
- ✅ 输出图片质量良好
- ✅ 跨平台兼容性良好

---

## 9. 风险分析

### 9.1 已识别风险与解决方案
| 风险 | 影响 | 概率 | 解决方案 |
|------|------|------|----------|
| EXIF信息缺失 | 中 | 高 | ✅ 实现文件时间备选机制 |
| 不支持的图片格式 | 低 | 中 | ✅ 格式验证和跳过机制 |
| 系统字体缺失 | 低 | 低 | ✅ 多路径字体查找和默认字体 |
| 大文件处理性能 | 中 | 低 | ✅ PIL优化和适当的质量设置 |

---

## 10. 测试需求

### 10.1 测试用例覆盖
1. **EXIF测试**: 使用带EXIF的真实照片和生成图片
2. **无EXIF测试**: 使用无EXIF信息的图片
3. **批量测试**: 处理包含多张图片的目录
4. **配置测试**: 各种水印样式和位置组合
5. **异常测试**: 无效路径、损坏文件等异常情况

### 10.2 测试数据
- `samples/test_photo_1.jpg`: 无EXIF信息的测试图片
- `samples/test_photo_with_exif.jpg`: 带EXIF信息的生成图片（拍摄时间：2023:08:15 14:30:45）
- 配置样例: `config/default_config.yaml`

---

## 11. 部署需求

### 11.1 环境依赖
```txt
Python >= 3.8
Pillow >= 10.0.0
ExifRead >= 3.0.0
PyYAML >= 6.0.0
piexif >= 1.1.3 (用于测试图片生成)
```

### 11.2 安装与运行
```bash
# 安装依赖
pip install -r requirements.txt

# 基本使用
python -m src.main samples/test_photo_with_exif.jpg

# 详细信息显示
python -m src.main samples/ --show-watermark-info

# 自定义样式
python -m src.main samples/test_photo_1.jpg --font-size 60 --color red --position center
```

---

## 12. 开发日志

### 12.1 主要功能实现
- ✅ 模块导入路径修复
- ✅ EXIF信息读取（支持PIL和ExifRead双库）
- ✅ 备选日期机制（文件修改时间）
- ✅ 水印样式配置（字体、颜色、位置）
- ✅ 批量处理和统计
- ✅ 详细信息显示功能
- ✅ YAML配置文件支持
- ✅ 跨平台字体支持
- ✅ 完善的错误处理和日志

### 12.2 测试验证
- ✅ 无EXIF图片处理（使用文件时间：2025-09-24）
- ✅ 带EXIF图片处理（使用拍摄时间：2023-08-15）
- ✅ 多种水印样式测试
- ✅ 批量处理测试
- ✅ 异常处理测试

---

**文档状态**: ✅ 完成
**最后更新**: 2025-09-24
**开发模式**: Vibe Coding with Claude Code